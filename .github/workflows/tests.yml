# Nome do workflow que aparece na aba Actions do GitHub
name: Testes UnitÃ¡rios

# Define quando o workflow serÃ¡ executado
on:
  # Executa quando houver push na branch main
  push:
    branches: [ main ]
  
  # Executa quando houver pull request para a branch main
  pull_request:
    branches: [ main ]
  
  # Permite executar manualmente pela interface do GitHub
  workflow_dispatch:

# Define os jobs (trabalhos) que serÃ£o executados
jobs:
  # Nome do job
  test:
    # Nome que aparece na interface
    name: Executar Testes
    
    # Sistema operacional onde o job serÃ¡ executado
    # OpÃ§Ãµes: ubuntu-latest, windows-latest, macos-latest
    runs-on: ubuntu-latest

    # Apontar para backend
    defaults:
      run:
        working-directory: ./backend
    
    # EstratÃ©gia de matriz para testar em mÃºltiplas versÃµes do Node
    strategy:
      matrix:
        # VersÃµes do Node.js para testar
        node-version: [18.x, 20.x]
    
    # Passos que serÃ£o executados
    steps:
      # 1. Checkout do cÃ³digo
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      # 2. Configurar Node.js
      - name: Configurar Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          # Cache de dependÃªncias para acelerar builds
          cache: 'npm'
          cache-dependency-path: './backend/package-lock.json'
      
      # 3. Instalar dependÃªncias
      - name: Instalar dependÃªncias
        run: npm ci
      
      # 4. Executar testes
      - name: Executar testes
        run: npm test
      
      # 5. Gerar relatÃ³rio de cobertura
      - name: Gerar cobertura de cÃ³digo
        run: npm run test:coverage
      
      # 6. Upload do relatÃ³rio de cobertura (opcional)
      - name: Upload relatÃ³rio de cobertura
        uses: actions/upload-artifact@v4
        if: matrix.node-version == '20.x'
        with:
          name: coverage-report
          path: backend/coverage/
          retention-days: 30
      
      # 7. Comentar cobertura no PR (opcional - requer configuraÃ§Ã£o adicional)
      - name: Resumo da cobertura
        if: matrix.node-version == '20.x'
        run: |
          echo "## ðŸ“Š RelatÃ³rio de Cobertura" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npm run test:coverage 2>&1 | grep -A 10 "All files" >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
